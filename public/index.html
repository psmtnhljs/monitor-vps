<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ÂÆûÊó∂ÁõëÊéßÂÖ®ÁêÉVPSËäÇÁÇπÂØπ‰∏≠ÂõΩ‰∏âÂ§ßËøêËê•ÂïÜÁöÑÁΩëÁªúËøûÊé•Ë¥®Èáè">
    <title>VPSÁΩëÁªúË¥®ÈáèÁõëÊµã</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .nodes-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .node-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: all 0.3s ease;
            position: relative;
        }

        .node-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .node-name {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .country-flag {
            font-size: 1.2em;
            margin-right: 8px;
            display: inline-block;
        }

        .node-location {
            color: #666;
            font-size: 0.9em;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .node-details {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .test-results {
            margin-top: 15px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-label {
            font-weight: 500;
        }

        .test-value {
            color: #333;
        }

        .latency-good { color: #28a745; }
        .latency-warning { color: #ffc107; }
        .latency-bad { color: #dc3545; }

        .chart-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
            transition: background 0.3s ease;
        }

        .chart-button:hover {
            background: #5a6fd8;
        }

        .chart-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 85%;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-right: 40px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .chart-controls-modal {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group-modal {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group-modal label {
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }

        .control-group-modal select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9em;
        }

        .chart-container-modal {
            position: relative;
            height: 400px;
            margin-top: 20px;
            background: #fafafa;
            border-radius: 5px;
            padding: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .nodes-grid {
                grid-template-columns: 1fr;
            }

            .chart-controls-modal {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header" role="banner">
            <h1>üåê VPSÁΩëÁªúË¥®ÈáèÁõëÊµã</h1>
            <p>ÂÆûÊó∂ÁõëÊéßÂÖ®ÁêÉVPSËäÇÁÇπÂØπ‰∏≠ÂõΩ‰∏âÂ§ßËøêËê•ÂïÜÁöÑÁΩëÁªúËøûÊé•Ë¥®Èáè</p>
        </header>

        <!-- ÁªüËÆ°Ê¶ÇËßà -->
        <section class="stats-grid" aria-label="ÁªüËÆ°Ê¶ÇËßà">
            <article class="stat-card">
                <div class="stat-number" id="totalNodes" aria-live="polite">-</div>
                <div class="stat-label">ÊÄªËäÇÁÇπÊï∞</div>
            </article>
            <article class="stat-card">
                <div class="stat-number" id="onlineNodes" aria-live="polite">-</div>
                <div class="stat-label">Âú®Á∫øËäÇÁÇπ</div>
            </article>
            <article class="stat-card">
                <div class="stat-number" id="recentTests" aria-live="polite">-</div>
                <div class="stat-label">Ëøë1Â∞èÊó∂ÊµãËØï</div>
            </article>
            <article class="stat-card">
                <div class="stat-number" id="monitoredISPs" aria-live="polite">-</div>
                <div class="stat-label">ÁõëÊéßËøêËê•ÂïÜ</div>
            </article>
        </section>

        <!-- VPSËäÇÁÇπÁä∂ÊÄÅ -->
        <section class="nodes-section" aria-label="VPSËäÇÁÇπÁä∂ÊÄÅ">
            <div class="section-title">
                üìä VPSËäÇÁÇπÁä∂ÊÄÅ
                <button class="refresh-btn" onclick="loadNodes()" aria-label="Âà∑Êñ∞ËäÇÁÇπÁä∂ÊÄÅ">Âà∑Êñ∞</button>
            </div>
            <div id="nodesContainer" class="nodes-grid">
                <div class="loading" aria-live="polite">
                    <div class="spinner" role="status"></div>
                    Ê≠£Âú®Âä†ËΩΩËäÇÁÇπ‰ø°ÊÅØ...
                </div>
            </div>
        </section>

        <!-- ÂõæË°®Ê®°ÊÄÅÊ°Ü -->
        <div id="chartModal" class="modal" role="dialog" aria-labelledby="modalTitle">
            <div class="modal-content">
                <span class="close" aria-label="ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü">&times;</span>
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">ËäÇÁÇπÂª∂ËøüË∂ãÂäøÂõæ</h2>
                    <div class="chart-controls-modal">
                        <div class="control-group-modal">
                            <label for="modalIspSelect">ËøêËê•ÂïÜ:</label>
                            <select id="modalIspSelect" aria-label="ÈÄâÊã©ËøêËê•ÂïÜ">
                                <option value="china_telecom">‰∏≠ÂõΩÁîµ‰ø°</option>
                                <option value="china_unicom">‰∏≠ÂõΩËÅîÈÄö</option>
                                <option value="china_mobile">‰∏≠ÂõΩÁßªÂä®</option>
                            </select>
                        </div>
                        <div class="control-group-modal">
                            <label for="modalTimeRange">Êó∂Èó¥ËåÉÂõ¥:</label>
                            <select id="modalTimeRange" aria-label="ÈÄâÊã©Êó∂Èó¥ËåÉÂõ¥">
                                <option value="1h">1Â∞èÊó∂</option>
                                <option value="6h">6Â∞èÊó∂</option>
                                <option value="24h">24Â∞èÊó∂</option>
                                <option value="7d">7Â§©</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="chart-container-modal">
                    <canvas id="modalChart" aria-label="ËäÇÁÇπÂª∂ËøüË∂ãÂäøÂõæË°®"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let modalChart = null;
        let currentNodeId = null;
        const API_BASE = window.location.origin;

        // Â∞ÜÂõΩÂÆ∂‰ª£Á†ÅËΩ¨Êç¢‰∏∫ÂõΩÊóóemoji
        function countryCodeToFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) {
                return 'üåê'; // ÈªòËÆ§Âú∞ÁêÉÂõæÊ†á
            }
            
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt(0));
            
            return String.fromCodePoint(...codePoints);
        }

        // ËÆæÁΩÆÊ®°ÊÄÅÊ°Ü
        function setupModal() {
            const modal = document.getElementById('chartModal');
            const closeBtn = document.querySelector('.close');
            
            // ÁÇπÂáªÂÖ≥Èó≠ÊåâÈíÆ
            closeBtn.onclick = () => closeModal();
            
            // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
            window.onclick = (event) => {
                if (event.target === modal) closeModal();
            };
            
            // ESCÈîÆÂÖ≥Èó≠
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modal.style.display === 'block') {
                    closeModal();
                }
            });
            
            // ÁªëÂÆöÊéß‰ª∂‰∫ã‰ª∂
            document.getElementById('modalIspSelect').addEventListener('change', loadModalChart);
            document.getElementById('modalTimeRange').addEventListener('change', loadModalChart);
        }

        // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
        function openChart(nodeId, nodeName) {
            currentNodeId = nodeId;
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalTitle');

            modalTitle.textContent = `${nodeName} - ÁΩëÁªúÂª∂ËøüË∂ãÂäøÂõæ`;
            modal.style.display = 'block';
            loadModalChart();
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'none';
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
        }

        // Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØ
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                document.getElementById('totalNodes').textContent = data.total_nodes ?? 0;
                document.getElementById('onlineNodes').textContent = data.online_nodes ?? 0;
                document.getElementById('recentTests').textContent = data.recent_tests ?? 0;
                document.getElementById('monitoredISPs').textContent = data.monitored_isps ?? 0;
            } catch (error) {
                console.error('Ëé∑ÂèñÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•:', error);
            }
        }

        // Âä†ËΩΩËäÇÁÇπÂàóË°®
        async function loadNodes() {
            const container = document.getElementById('nodesContainer');

            try {
                const response = await fetch(`${API_BASE}/api/nodes`);
                if (!response.ok) throw new Error('Network response was not ok');
                const nodes = await response.json();

                if (nodes.length === 0) {
                    container.innerHTML = '<div class="loading">ÊöÇÊó†ËäÇÁÇπÊï∞ÊçÆ</div>';
                    return;
                }

                container.innerHTML = '';

                for (const node of nodes) {
                    const latestData = await loadLatestData(node.id);
                    const nodeCard = createNodeCard(node, latestData);
                    container.appendChild(nodeCard);
                }
            } catch (error) {
                console.error('Ëé∑ÂèñËäÇÁÇπÂàóË°®Â§±Ë¥•:', error);
                container.innerHTML = '<div class="error-message">Âä†ËΩΩËäÇÁÇπ‰ø°ÊÅØÂ§±Ë¥•</div>';
            }
        }

        // Ëé∑ÂèñËäÇÁÇπÊúÄÊñ∞Êï∞ÊçÆ
        async function loadLatestData(nodeId) {
            try {
                const response = await fetch(`${API_BASE}/api/nodes/${nodeId}/latest`);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error(`Ëé∑ÂèñËäÇÁÇπ ${nodeId} ÊúÄÊñ∞Êï∞ÊçÆÂ§±Ë¥•:`, error);
                return [];
            }
        }

        // ÂàõÂª∫ËäÇÁÇπÂç°Áâá
        function createNodeCard(node, latestData) {
            const card = document.createElement('div');
            card.className = 'node-card';
            
            const statusClass = `status-${node.connection_status}`;
            const statusText = {
                'online': 'Âú®Á∫ø',
                'warning': 'Ë≠¶Âëä',
                'offline': 'Á¶ªÁ∫ø'
            }[node.connection_status] || 'Êú™Áü•';
            
            // ISPÂêçÁß∞Êò†Â∞Ñ
            const ispNameMap = {
                'china_mobile': '‰∏≠ÂõΩÁßªÂä®',
                'china_telecom': '‰∏≠ÂõΩÁîµ‰ø°',
                'china_unicom': '‰∏≠ÂõΩËÅîÈÄö'
            };
            
            // Ëé∑ÂèñÂõΩÊóó
            const flag = countryCodeToFlag(node.country_code);
            
            // ËÆ°ÁÆóÁ¶ªÁ∫øÊó∂Èó¥
            let offlineInfo = '';
            if (node.minutes_since_last_seen !== undefined) {
                const minutes = Math.round(node.minutes_since_last_seen);
                if (minutes < 60) {
                    offlineInfo = `${minutes}ÂàÜÈíüÂâç`;
                } else if (minutes < 1440) {
                    offlineInfo = `${Math.round(minutes/60)}Â∞èÊó∂Ââç`;
                } else {
                    offlineInfo = `${Math.round(minutes/1440)}Â§©Ââç`;
                }
            }
            
            let testResultsHtml = '';
            if (latestData?.length > 0) {
                testResultsHtml = '<div class="test-results">';
                latestData.forEach(result => {
                    const latencyClass = getLatencyClass(result.avg_latency);
                    const displayName = ispNameMap[result.isp_name] || result.isp_name;
                    testResultsHtml += `
                        <div class="test-item">
                            <span class="test-label">${displayName}</span>
                            <span class="test-value ${latencyClass}">
                                ${result.avg_latency ? result.avg_latency.toFixed(1) + 'ms' : 'N/A'}
                                ${result.packet_loss ? `(${result.packet_loss.toFixed(1)}% ‰∏¢ÂåÖ)` : ''}
                            </span>
                        </div>
                    `;
                });
                testResultsHtml += '</div>';
            } else {
                testResultsHtml = '<div class="test-results"><div class="test-item">ÊöÇÊó†ÊµãËØïÊï∞ÊçÆ</div></div>';
            }
            
            // ÊòæÁ§∫‰ΩçÁΩÆ‰ø°ÊÅØ
            const locationDisplay = node.city && node.country_name ? 
                `${node.city}, ${node.country_name}` : 
                (node.location || 'Êú™Áü•‰ΩçÁΩÆ');
            
            // ÊòæÁ§∫Êèê‰æõÂïÜ‰ø°ÊÅØÔºàÂ¶ÇÊûú‰∏çÊòØAuto-detectÁöÑËØùÔºâ
            const providerDisplay = (node.provider && node.provider !== 'Auto-detect') ? 
                ` - ${node.provider}` : 
                (node.isp ? ` - ${node.isp}` : '');
            
            card.innerHTML = `
                <div class="node-header">
                    <div>
                        <div class="node-name">
                            <span class="country-flag">${flag}</span>
                            ${node.name}
                        </div>
                        <div class="node-location">${locationDisplay}${providerDisplay}</div>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="node-details">
                    ${node.ip_address ? `<div>IP: ${node.ip_address}</div>` : ''}
                    <div>ÊúÄÂêéÂú®Á∫ø: ${new Date(node.last_seen).toLocaleString('zh-CN')} ${offlineInfo ? `(${offlineInfo})` : ''}</div>
                </div>
                ${testResultsHtml}
                <button class="chart-button" onclick="openChart(${node.id}, '${node.name.replace(/'/g, "\\'")}')" aria-label="Êü•Áúã ${node.name} ÁöÑÂª∂ËøüË∂ãÂäøÂõæ">
                    üìä Êü•ÁúãÂª∂ËøüË∂ãÂäøÂõæ
                </button>
            `;
            
            return card;
        }

        // Ê†πÊçÆÂª∂ËøüËé∑ÂèñÊ†∑ÂºèÁ±ª
        function getLatencyClass(latency) {
            if (!latency) return '';
            if (latency < 100) return 'latency-good';
            if (latency < 200) return 'latency-warning';
            return 'latency-bad';
        }

        // Âä†ËΩΩÊ®°ÊÄÅÊ°ÜÂõæË°®Êï∞ÊçÆ
        async function loadModalChart() {
            if (!currentNodeId) return;

            const ispName = document.getElementById('modalIspSelect').value;
            const timeRange = document.getElementById('modalTimeRange').value;

            try {
                const response = await fetch(`${API_BASE}/api/chart-data/${currentNodeId}/${ispName}?timeRange=${timeRange}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                updateModalChart(data);
            } catch (error) {
                console.error('Ëé∑ÂèñÂõæË°®Êï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // Êõ¥Êñ∞Ê®°ÊÄÅÊ°ÜÂõæË°®
        function updateModalChart(data) {
            const ctx = document.getElementById('modalChart').getContext('2d');

            if (modalChart) {
                modalChart.destroy();
            }

            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'PingÂª∂Ëøü (ms)',
                            data: data.ping.map(p => p.y),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1,
                            fill: true,
                            pointBackgroundColor: 'rgb(75, 192, 192)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const dataPoint = data.ping[context.dataIndex];
                                    if (dataPoint && dataPoint.packetLoss !== undefined) {
                                        return `‰∏¢ÂåÖÁéá: ${dataPoint.packetLoss.toFixed(1)}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Âª∂Ëøü (ms)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Êó∂Èó¥'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    }
                }
            });
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadNodes();
            setupModal();
            setInterval(loadStats, 30000);
            setInterval(loadNodes, 60000);
        });
    </script>
</body>
</html>