<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="å®æ—¶ç›‘æ§å…¨çƒVPSèŠ‚ç‚¹å¯¹ä¸­å›½ä¸‰å¤§è¿è¥å•†çš„ç½‘ç»œè¿æ¥è´¨é‡">
    <title>VPSç½‘ç»œè´¨é‡ç›‘æµ‹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .nodes-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .node-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
            transition: all 0.3s ease;
            position: relative;
        }

        .node-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .node-name {
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .country-flag {
            font-size: 1.2em;
            margin-right: 8px;
            display: inline-block;
        }

        .node-location {
            color: #666;
            font-size: 0.9em;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-online {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }

        .node-details {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .test-results {
            margin-top: 15px;
        }

        .test-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .test-item:last-child {
            border-bottom: none;
        }

        .test-label {
            font-weight: 500;
        }

        .test-value {
            color: #333;
        }

        .latency-good { color: #28a745; }
        .latency-warning { color: #ffc107; }
        .latency-bad { color: #dc3545; }

        .chart-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            width: 100%;
            transition: background 0.3s ease;
        }

        .chart-button:hover {
            background: #5a6fd8;
        }

        .chart-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 85%;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 10px;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-right: 40px;
        }

        .modal-title {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .chart-controls-modal {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group-modal {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group-modal label {
            font-weight: 500;
            color: #555;
            font-size: 0.9em;
        }

        .control-group-modal select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9em;
        }

        .chart-container-modal {
            position: relative;
            height: 400px;
            margin-top: 20px;
            background: #fafafa;
            border-radius: 5px;
            padding: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .nodes-grid {
                grid-template-columns: 1fr;
            }

            .chart-controls-modal {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header" role="banner">
            <h1>ğŸŒ VPSç½‘ç»œè´¨é‡ç›‘æµ‹</h1>
            <p>å®æ—¶ç›‘æ§å…¨çƒVPSèŠ‚ç‚¹å¯¹ä¸­å›½ä¸‰å¤§è¿è¥å•†çš„ç½‘ç»œè¿æ¥è´¨é‡</p>
        </header>

        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
        <section class="stats-grid" aria-label="ç»Ÿè®¡æ¦‚è§ˆ">
            <article class="stat-card">
                <div class="stat-number" id="totalNodes" aria-live="polite">-</div>
                <div class="stat-label">æ€»èŠ‚ç‚¹æ•°</div>
            </article>
            <article class="stat-card">
                <div class="stat-number" id="onlineNodes" aria-live="polite">-</div>
                <div class="stat-label">åœ¨çº¿èŠ‚ç‚¹</div>
            </article>
            <article class="stat-card">
                <div class="stat-number" id="recentTests" aria-live="polite">-</div>
                <div class="stat-label">è¿‘1å°æ—¶æµ‹è¯•</div>
            </article>
            <article class="stat-card">
                <div class="stat-number" id="monitoredISPs" aria-live="polite">-</div>
                <div class="stat-label">ç›‘æ§è¿è¥å•†</div>
            </article>
        </section>

        <!-- VPSèŠ‚ç‚¹çŠ¶æ€ -->
        <section class="nodes-section" aria-label="VPSèŠ‚ç‚¹çŠ¶æ€">
            <div class="section-title">
                ğŸ“Š VPSèŠ‚ç‚¹çŠ¶æ€
                <button class="refresh-btn" onclick="loadNodes()" aria-label="åˆ·æ–°èŠ‚ç‚¹çŠ¶æ€">åˆ·æ–°</button>
            </div>
            <div id="nodesContainer" class="nodes-grid">
                <div class="loading" aria-live="polite">
                    <div class="spinner" role="status"></div>
                    æ­£åœ¨åŠ è½½èŠ‚ç‚¹ä¿¡æ¯...
                </div>
            </div>
        </section>

        <!-- å›¾è¡¨æ¨¡æ€æ¡† -->
        <div id="chartModal" class="modal" role="dialog" aria-labelledby="modalTitle">
            <div class="modal-content">
                <span class="close" aria-label="å…³é—­æ¨¡æ€æ¡†">&times;</span>
                <div class="modal-header">
                    <h2 class="modal-title" id="modalTitle">èŠ‚ç‚¹å»¶è¿Ÿè¶‹åŠ¿å›¾</h2>
                    <div class="chart-controls-modal">
                        <div class="control-group-modal">
                            <label for="modalIspSelect">è¿è¥å•†:</label>
                            <select id="modalIspSelect" aria-label="é€‰æ‹©è¿è¥å•†">
                                <option value="china_telecom">ä¸­å›½ç”µä¿¡</option>
                                <option value="china_unicom">ä¸­å›½è”é€š</option>
                                <option value="china_mobile">ä¸­å›½ç§»åŠ¨</option>
                            </select>
                        </div>
                        <div class="control-group-modal">
                            <label for="modalTimeRange">æ—¶é—´èŒƒå›´:</label>
                            <select id="modalTimeRange" aria-label="é€‰æ‹©æ—¶é—´èŒƒå›´">
                                <option value="1h">1å°æ—¶</option>
                                <option value="6h">6å°æ—¶</option>
                                <option value="24h">24å°æ—¶</option>
                                <option value="7d">7å¤©</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="chart-container-modal">
                    <canvas id="modalChart" aria-label="èŠ‚ç‚¹å»¶è¿Ÿè¶‹åŠ¿å›¾è¡¨"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let modalChart = null;
        let currentNodeId = null;
        const API_BASE = window.location.origin;

        // å°†å›½å®¶ä»£ç è½¬æ¢ä¸ºå›½æ——emoji
        function countryCodeToFlag(countryCode) {
            if (!countryCode || countryCode.length !== 2) {
                return 'ğŸŒ'; // é»˜è®¤åœ°çƒå›¾æ ‡
            }
            
            const codePoints = countryCode
                .toUpperCase()
                .split('')
                .map(char => 127397 + char.charCodeAt(0));
            
            return String.fromCodePoint(...codePoints);
        }

        // è®¾ç½®æ¨¡æ€æ¡†
        function setupModal() {
            const modal = document.getElementById('chartModal');
            const closeBtn = document.querySelector('.close');
            
            // ç‚¹å‡»å…³é—­æŒ‰é’®
            closeBtn.onclick = () => closeModal();
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.onclick = (event) => {
                if (event.target === modal) closeModal();
            };
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && modal.style.display === 'block') {
                    closeModal();
                }
            });
            
            // ç»‘å®šæ§ä»¶äº‹ä»¶
            document.getElementById('modalIspSelect').addEventListener('change', loadModalChart);
            document.getElementById('modalTimeRange').addEventListener('change', loadModalChart);
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openChart(nodeId, nodeName) {
            currentNodeId = nodeId;
            const modal = document.getElementById('chartModal');
            const modalTitle = document.getElementById('modalTitle');

            modalTitle.textContent = `${nodeName} - ç½‘ç»œå»¶è¿Ÿè¶‹åŠ¿å›¾`;
            modal.style.display = 'block';
            loadModalChart();
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('chartModal');
            modal.style.display = 'none';
            if (modalChart) {
                modalChart.destroy();
                modalChart = null;
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/api/stats`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                document.getElementById('totalNodes').textContent = data.total_nodes ?? 0;
                document.getElementById('onlineNodes').textContent = data.online_nodes ?? 0;
                document.getElementById('recentTests').textContent = data.recent_tests ?? 0;
                document.getElementById('monitoredISPs').textContent = data.monitored_isps ?? 0;
            } catch (error) {
                console.error('è·å–ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½èŠ‚ç‚¹åˆ—è¡¨
        async function loadNodes() {
            const container = document.getElementById('nodesContainer');

            try {
                const response = await fetch(`${API_BASE}/api/nodes`);
                if (!response.ok) throw new Error('Network response was not ok');
                const nodes = await response.json();

                if (nodes.length === 0) {
                    container.innerHTML = '<div class="loading">æš‚æ— èŠ‚ç‚¹æ•°æ®</div>';
                    return;
                }

                container.innerHTML = '';

                for (const node of nodes) {
                    const latestData = await loadLatestData(node.id);
                    const nodeCard = createNodeCard(node, latestData);
                    container.appendChild(nodeCard);
                }
            } catch (error) {
                console.error('è·å–èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="error-message">åŠ è½½èŠ‚ç‚¹ä¿¡æ¯å¤±è´¥</div>';
            }
        }

        // è·å–èŠ‚ç‚¹æœ€æ–°æ•°æ®
        async function loadLatestData(nodeId) {
            try {
                const response = await fetch(`${API_BASE}/api/nodes/${nodeId}/latest`);
                if (!response.ok) throw new Error('Network response was not ok');
                return await response.json();
            } catch (error) {
                console.error(`è·å–èŠ‚ç‚¹ ${nodeId} æœ€æ–°æ•°æ®å¤±è´¥:`, error);
                return [];
            }
        }

        // åˆ›å»ºèŠ‚ç‚¹å¡ç‰‡
        function createNodeCard(node, latestData) {
            const card = document.createElement('div');
            card.className = 'node-card';
            
            const statusClass = `status-${node.connection_status}`;
            const statusText = {
                'online': 'åœ¨çº¿',
                'warning': 'è­¦å‘Š',
                'offline': 'ç¦»çº¿'
            }[node.connection_status] || 'æœªçŸ¥';
            
            // ISPåç§°æ˜ å°„
            const ispNameMap = {
                'china_mobile': 'ä¸­å›½ç§»åŠ¨',
                'china_telecom': 'ä¸­å›½ç”µä¿¡',
                'china_unicom': 'ä¸­å›½è”é€š'
            };
            
            // è·å–å›½æ——
            const flag = countryCodeToFlag(node.country_code);
            
            // è®¡ç®—ç¦»çº¿æ—¶é—´
            let offlineInfo = '';
            if (node.minutes_since_last_seen !== undefined) {
                const minutes = Math.round(node.minutes_since_last_seen);
                if (minutes < 60) {
                    offlineInfo = `${minutes}åˆ†é’Ÿå‰`;
                } else if (minutes < 1440) {
                    offlineInfo = `${Math.round(minutes/60)}å°æ—¶å‰`;
                } else {
                    offlineInfo = `${Math.round(minutes/1440)}å¤©å‰`;
                }
            }
            
            let testResultsHtml = '';
            if (latestData?.length > 0) {
                testResultsHtml = '<div class="test-results">';
                latestData.forEach(result => {
                    const latencyClass = getLatencyClass(result.avg_latency);
                    const displayName = ispNameMap[result.isp_name] || result.isp_name;
                    testResultsHtml += `
                        <div class="test-item">
                            <span class="test-label">${displayName}</span>
                            <span class="test-value ${latencyClass}">
                                ${result.avg_latency ? result.avg_latency.toFixed(1) + 'ms' : 'N/A'}
                                ${result.packet_loss ? `(${result.packet_loss.toFixed(1)}% ä¸¢åŒ…)` : ''}
                            </span>
                        </div>
                    `;
                });
                testResultsHtml += '</div>';
            } else {
                testResultsHtml = '<div class="test-results"><div class="test-item">æš‚æ— æµ‹è¯•æ•°æ®</div></div>';
            }
            
            // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
            const locationDisplay = node.city && node.country_name ? 
                `${node.city}, ${node.country_name}` : 
                (node.location || 'æœªçŸ¥ä½ç½®');
            
            // æ˜¾ç¤ºæä¾›å•†ä¿¡æ¯ï¼ˆå¦‚æœä¸æ˜¯Auto-detectçš„è¯ï¼‰
            const providerDisplay = (node.provider && node.provider !== 'Auto-detect') ? 
                ` - ${node.provider}` : 
                (node.isp ? ` - ${node.isp}` : '');
            
            card.innerHTML = `
                <div class="node-header">
                    <div>
                        <div class="node-name">
                            <span class="country-flag">${flag}</span>
                            ${node.name}
                        </div>
                        <div class="node-location">${locationDisplay}${providerDisplay}</div>
                    </div>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <div class="node-details">
                    ${node.ip_address ? `<div>IP: ${node.ip_address}</div>` : ''}
                    <div>æœ€ååœ¨çº¿: ${new Date(node.last_seen).toLocaleString('zh-CN')} ${offlineInfo ? `(${offlineInfo})` : ''}</div>
                </div>
                ${testResultsHtml}
                <button class="chart-button" onclick="openChart(${node.id}, '${node.name.replace(/'/g, "\\'")}')" aria-label="æŸ¥çœ‹ ${node.name} çš„å»¶è¿Ÿè¶‹åŠ¿å›¾">
                    ğŸ“Š æŸ¥çœ‹å»¶è¿Ÿè¶‹åŠ¿å›¾
                </button>
            `;
            
            return card;
        }

        // æ ¹æ®å»¶è¿Ÿè·å–æ ·å¼ç±»
        function getLatencyClass(latency) {
            if (!latency) return '';
            if (latency < 100) return 'latency-good';
            if (latency < 200) return 'latency-warning';
            return 'latency-bad';
        }

        // åŠ è½½æ¨¡æ€æ¡†å›¾è¡¨æ•°æ®
        async function loadModalChart() {
            if (!currentNodeId) return;

            const ispName = document.getElementById('modalIspSelect').value;
            const timeRange = document.getElementById('modalTimeRange').value;

            try {
                const response = await fetch(`${API_BASE}/api/chart-data/${currentNodeId}/${ispName}?timeRange=${timeRange}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                updateModalChart(data);
            } catch (error) {
                console.error('è·å–å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æ¨¡æ€æ¡†å›¾è¡¨
        function updateModalChart(data) {
            const ctx = document.getElementById('modalChart').getContext('2d');

            if (modalChart) {
                modalChart.destroy();
            }

            modalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: 'Pingå»¶è¿Ÿ (ms)',
                            data: data.ping.map(p => p.y),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1,
                            fill: true,
                            pointBackgroundColor: 'rgb(75, 192, 192)',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const dataPoint = data.ping[context.dataIndex];
                                    if (dataPoint && dataPoint.packetLoss !== undefined) {
                                        return `ä¸¢åŒ…ç‡: ${dataPoint.packetLoss.toFixed(1)}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'å»¶è¿Ÿ (ms)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    elements: {
                        line: {
                            borderWidth: 3
                        }
                    }
                }
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadNodes();
            setupModal();
            setInterval(loadStats, 30000);
            setInterval(loadNodes, 60000);
        });
    </script>
</body>
</html>